<?php

    define('ICONS', [
        'default_file' => '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><title>default_file</title><path d="M20.414,2H5V30H27V8.586ZM7,28V4H19v6h6V28Z" style="fill:#c5c5c5"/></svg>',
        'default_folder' => '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><title>default_folder</title><path d="M27.5,5.5H18.2L16.1,9.7H4.4V26.5H29.6V5.5Zm0,4.2H19.3l1.1-2.1h7.1Z" style="fill:#c09553"/></svg>'
    ]);

    define('QUOTES', [
        // Warren Buffet
        'Someone\'s sitting in the shade today because someone planted a tree a long time ago.' => 'Warren Buffett',
        'If you aren\'t willing to own a stock for 10 years, don\'t even think about owning it for 10 minutes.' => 'Warren Buffett',
        'The most important investment you can make is in yourself.' => 'Warren Buffett',
        'I will tell you how to become rich. Close the doors. Be fearful when others are greedy. Be greedy when others are fearful.' => 'Warren Buffett',
        'Never depend on a single income. Make an investment to create a second source.' => 'Warren Buffett',
        'No matter how great the talent or efforts, some things just take time. You can\'t produce a baby in one month by getting nine women pregnant.' => 'Warren Buffett',
        'Don\'t pass up something that\'s attractive today because you think you will find something better tomorrow.' => 'Warren Buffett',
        'You only have to do a few things right in your life so long as you don\'t do too many things wrong.' => 'Warren Buffett',

        // Albert Einstein
        'Imagination is everything. It is the preview of life\'s coming attractions.' => 'Albert Einstein',
        'Creativity is seeing what others see and thinking what no one else ever thought.' => 'Albert Einstein',
        'The true sign of intelligence is not knowledge, but imagination.' => 'Albert Einstein',
        
        // Busines
        'Success is not final; failure is not fatal: it is the courage to continue that counts.' => 'Winston Churchill',
        'Play by the rules, but be ferocious.' => 'Phil Knight',
        'Business opportunities are like buses, there\'s always another one coming.' => 'Richard Branson',
        'Every problem is a gift—without problems we would not grow.' => 'Anthony Robbins',
        'Success usually comes to those who are too busy to be looking for it.' => 'Henry David Thoreau',
        'There\'s no shortage of remarkable ideas, what\'s missing is the will to execute them.' => 'Seth Godin',
        'I owe my success to having listened respectfully to the very best advice, and then going away and doing the exact opposite.' => 'G.K. Chesterton',
        'I don\'t know the word \'quit.\' Either I never did, or I have abolished it.' => 'Susan Butcher',
        'Far and away the best prize that life offers is the chance to work hard at work worth doing.' => 'Theodore Roosevelt',
        'If you really look closely, most overnight successes took a long time.' => 'Steve Jobs',
        'Almost everything worthwhile carries with it some sort of risk, whether it\'s starting a new business, whether it\'s leaving home, whether it\'s getting married, or whether it\'s flying into space.' => 'Chris Hadfield',
        'Even if you are on the right track, you\'ll get run over if you just sit there.' => 'Will Rodgers',
        'The real test is not whether you avoid this failure, because you won\'t. It\'s whether you let it harden or shame you into inaction, or whether you learn from it; whether you choose to persevere.' => 'Barack Obama',
        'Forget past mistakes. Forget failures. Forget everything except what you\'re going to do now and do it.' => 'William Durant',
        'Character cannot be developed in ease and quiet. Only through experience of trial and suffering can the soul be strengthened, ambition inspired and success achieved.' => 'Helen Keller',
        'The first one gets the oyster, the second gets the shell.' => 'Andrew Carnegie',
        'The way to get started is to quit talking and begin doing.' => 'Walt Disney',
        'Whether you think you can or whether you think you can\'t, you\'re right!' => 'Henry Ford',
        'There are no secrets to success. It is the result of preparation, hard work and learning from failure.' => 'Colin Powell',
        'Success is not the key to happiness. Happiness is the key to success. If you love what you are doing, you will be successful.' => 'Albert Schweitzer',
        'Success is often achieved by those who don\'t know that failure is inevitable.' => 'Coco Chanel',
        'Many of life\'s failures are people who did not realize how close they were to success when they gave up.' => 'Thomas Edison',
        'I feel that luck is preparation meeting opportunity.' => 'Oprah Winfrey',
        'I never dreamed about success. I worked for it.' => 'Estée Lauder', 
        'The only place where success comes before work is in the dictionary.' => 'Vidal Sassoon',
        'The only way around is through.' => 'Robert Frost',
        
        // Creativity
        'Art is the elimination of the unnecessary.' => 'Pablo Picasso',
        'You use a glass mirror to see your face. You use works of art to see your soul.' => 'George Bernard Shaw',
        'A creative life is an amplified life. It\'s a bigger life, a happier life, an expanded life, and a hell of a lot more interesting life' => 'Elizabeth Gilbert',
        'Don\'t wait for inspiration. It comes while working.' => 'Henri Matisse',
        'The worst enemy to creativity is self-doubt.' => 'Sylvia Plath',
        'Creativity is inventing, experimenting, growing, taking risks, breaking rules, making mistakes, and having fun.' => 'Mary Lou Cook',
        'It\'s no good being too easily swayed by people\'s opinions. You have to believe in yourself.' => 'Donatella Versace',
        'There is no doubt that creativity is the most important human resource of all. Without creativity, there would be no progress, and we would be forever repeating the same patterns.' => 'Edward De Bono',
        'Begin by learning to draw and paint like the old masters. After that, you can do as you like; everyone will respect you.' => 'Salvador Dali',
        'You can\'t use up creativity. The more you use, the more you have.' => 'Maya Angelou',
        'There is no innovation and creativity without failure.' => 'Brené Brown',
        'The creative process is a process of surrender, not control.' => 'Bruce Lee',
        'The creative adult is the child who survived.' => 'Ursula Le Guin',
        'Great things are done by a series of small things brought together.' => 'Vincent Van Gogh',
        'Make visible what, without you, might perhaps never have been seen.' => 'Oprah Winfrey',
        'Simplicity is the ultimate sophistication.' => 'Leonardo Da Vinci',
        'Draw the art you want to see, start the business you want to run, play the music you want to hear, write the books you want to read, build the products you want to use - do the work you want to see done.' => 'Austin Kleon',
        'Creativity is just connecting things. When you ask creative people how they did something, they feel a little guilty because they didn\'t really do it, they just saw something. It seemed obvious to them after a while.' => 'Steve Jobs',
        'Everything you can imagine is real.' => 'Pablo Picasso',
        'Imagination is the beginning of creation. You imagine what you desire, you will what you imagine, and at last, you create what you will.' => 'George Bernard Shaw',
        'Creativity is… seeing something that doesn\'t exist already. You need to find out how you can bring it into being and that way be a playmate with God.' => 'Michele Shea',
        'Everyone who\'s ever taken a shower has had an idea. It\'s the person who gets out of the shower, dries off, and does something about it who makes a difference.' => 'Nolan Bushnell',
        'Creativity can solve almost any problem. The creative act, the defeat of habit by originality, overcomes everything.' => 'George Lois',
        'Invention, it must be humbly admitted, does not consist in creating out of void but out of chaos.' => 'Mary Shelley',
        'True alchemy lies in this formula: \'Your memory and your senses are but the nourishment of your creative impulse.\'' => 'Arthur Rimbaud',
        'Odd how the creative power at once brings the whole universe to order.' => 'Virginia Woolf',
        
        // Programming
        'Any fool can write code that a computer can understand. Good programmers write code that humans can understand.' => 'Martin Fowler',
        'First, solve the problem. Then, write the code.' => 'John Johnson',
        'Experience is the name everyone gives to their mistakes.' => 'Oscar Wilde',
        'In order to be irreplaceable, one must always be different.' => 'Coco Chanel',
        'Java is to JavaScript what car is to Carpet.' => 'Chris Heilmann',
        'Knowledge is power.' => 'Francis Bacon',
        'Sometimes it pays to stay in bed on Monday, rather than spending the rest of the week debugging Monday\'s code.' => 'Dan Salomon', 
        'Perfection is achieved not when there is nothing more to add, but rather when there is nothing more to take away.' => 'Antoine de Saint-Exupery',
        'Ruby is rubbish! PHP is phpantastic!' => 'Nikita Popov',
        'Code is like humor. When you have to explain it, it\'s bad.' => 'Cory House',
        'Fix the cause, not the symptom.' => 'Steve Maguire',
        'Optimism is an occupational hazard of programming: feedback is the treatment.' => 'Kent Beck',
        'When to use iterative development? You should use iterative development only on projects that you want to succeed.' => 'Martin Fowler',
        'Simplicity is the soul of efficiency.' => 'Austin Freeman',
        'Before software can be reusable it first has to be usable.' => 'Ralph Johnson',
        'Make it work, make it right, make it fast.' => 'Kent Beck',

        // Others
        'There is nothing impossible to him who will try.' => 'Alexander the Great',
        'When you have a dream, you\'ve got to grab it and never let go.' => 'Carol Burnett',
        'Be courageous. Challenge orthodoxy. Stand up for what you believe in. When you are in your rocking chair talking to your grandchildren many years from now, be sure you have a good story to tell.' => 'Amal Clooney',
        'Success is not final, failure is not fatal: it is the courage to continue that counts.' => 'Winston Churchill',
        'You are never too old to set another goal or to dream a new dream.' => 'Malala Yousafzai',
        'Where your fear is, there is your task.' => 'Carl Jung',
        'Everything you ever wanted is on the other side of fear.' => 'George Adair'
    ]);
    
    class Helper {

        public static function debug_var(mixed $var, bool $exit = false): void {
            
            echo    '<br>
                    <fieldset style="border: 2px groove red; padding: 0 2rem">
                    <legend style="color: red; font-weight: bold">Debug</legend>
                    <pre style="text-align:left; font-size:12px">';

            switch (gettype($var)) {
                case 'array':
                case 'object':
                    echo htmlentities(print_r($var, true));
                    break;
                case 'string':
                    echo 'string(' . strlen($var) . ') "' . htmlentities($var) . '"';
                    break;
                default:
                    var_dump($var);
            }

            if ($exit) {
                echo "<br><u>Exit called from:</u><br>\t";

                debug_print_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS);

                exit('<br><strong>Execution explicitly terminated using <em>' . __METHOD__ . ' </em>method.</strong>');
            }
            echo '</pre></fieldset>';
        }
    }

    class File {
        public string $name;
        public string $date_edited;
        public int $size;
        public string $icon;

        // CONFIG
        // include sizes for directories (increased overhead)
        private static bool $dir_sizes = true;

        

        public function __construct(string $file_name) {
            $this->name = $file_name;

            $this->date_edited = $this->get_edit_date($file_name);
            $this->size = $this->get_size($file_name, self::$dir_sizes);
            $this->icon = $this->get_icon($file_name);

        }

        public static function format_bytes(int $bytes, bool $base_2 = false): array {
            $prefixes = [
                ['B', 'KiB', 'MiB', 'GiB', 'TiB', 'PiB', 'EiB', 'ZiB', 'YiB'],
                ['B', 'kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB']
            ];

            $prefix = $base_2 ? $prefixes[0] : $prefixes[1]; 
            $base = $base_2 ? 1024 : 1000;

            $exponent = floor(log($bytes, $base));

            return ['value' => round($bytes / pow($base, $exponent), 2), 'prefix' => $prefix[$exponent]];
        }

        private function get_edit_date(string $file_name): string {
            // day-month-year hours:minutes
            $time_format = 'd-m-Y G:i';

            return date($time_format, filemtime($file_name));
        }

        private function get_size(string $file_name, bool $dir_sizes): int {

            // $file_name = rtrim((str_replace('\\', '/', $file_name)), '/');
            $file_name = realpath($file_name);

            // OS specific checks (faster) || recursive directory traverse (slower)
            if ($dir_sizes && is_dir($file_name)) {
                $os = strtolower(substr(PHP_OS, 0, 3));

                // Windows Host (WIN32, WINNT, Windows)
                if ($os === 'win' && extension_loaded('com_dotnet')) {
                    $obj = new COM('scripting.filesystemobject');

                    if (is_object($obj)) {
                        $ref = $obj->getfolder($file_name);
                        $size = $ref->size;
                        $obj = null;
                        return $size;
                    }
                }
                // Unix Host (Linux, Mac OS)
                if ($os !== 'win') {
                    $io = popen('/usr/bin/du -sb ' . $file_name, 'r');

                    if ($io) {
                        $size = intval(fgets($io, 80));
                        pclose($io);
                        return $size;
                    }
                }
                // if system calls did't work, use slower recursive directory traverse method
                $size = 0;
                $files = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($file_name, FilesystemIterator::SKIP_DOTS));

                foreach ($files as $file) {
                    $size += $file->getSize();
                }
                return $size;

            } else {
                return filesize($file_name);
            }
        }

        private function get_icon(string $file_name): string {
          
            $ext = pathinfo($file_name, PATHINFO_EXTENSION);

            // folder
            if ($ext === '') {
                $folder_name = pathinfo($file_name, PATHINFO_FILENAME);
                $q = 'folder_type_' . $folder_name;
                return (array_key_exists($q, ICONS)) ? $q : ICONS['default_folder'];

            // file
            } else {
                $q = 'file_type_' . $ext;
                return (array_key_exists($q, ICONS)) ? $q : ICONS['default_file'];
            }
        }
    }

    // GET & POST requests
    switch ($_SERVER['REQUEST_METHOD']) {
        case 'POST':

            if ((bool) $_POST['open_root'] === true) {
                exec('start ' . __DIR__);
                header('Location: ' . $_SERVER['PHP_SELF']);
                exit();
            }

            break;

        case 'GET':
            break;
    }


    // main
    $dir = getcwd();

    // remove '.' -> current dir & '..' parent dir entries
    $file_names = array_values(array_diff(scandir($dir), ['.', '..']));
    $files = [];

    foreach ($file_names as $name) {
        $files[] = new File($name);
    }

    // get random quote
    $random_quote = array_rand(QUOTES);

    // total size of current folder
    $folder_size = 0;

?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Index Page</title>

    <meta name="description" content="Simple index page replacing default server's indexing.">

    <style>
        /* minified normalize.css */
        html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:rgba(0,0,0,0)}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}button,[type=button],[type=reset],[type=submit]{-webkit-appearance:button}button::-moz-focus-inner,[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring,[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}template{display:none}[hidden]{display:none}

        /* helper classes */
        html {
            box-sizing: border-box;
        }

        *, *::before, *::after {
            box-sizing: inherit;
        }

        body {
            font-family: "Century Schoolbook", Verdana, Arial, sans-serif;

            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: auto;
        }

        .container {
            margin: 0 auto;
        }
        
        .text-left {
            text-align: left !important;
        }

        .text-right {
            text-align: right !important;
        }

        .text-center {
            text-align: center !important;
        }

        .primary-text-clr {
            color: var(--primary-text-clr);
        }

        .secondary-text-clr {
            color: var(--secondary-text-clr);
        }

        /* main styles */
        :root {
            --secondary-text-clr: #696969;
            --primary-text-clr: #303030;

            --tr-dark-shade-clr: #DCDCDC;
            --tr-light-shade-clr: white;
        }



        .window {
            max-width: 640px;
        }
        
        .files {
            margin: 3em auto;
        }

        .icons a {
            text-decoration: none;
        }

        .icons svg {
            max-width: 1em;
            max-height: 1em;

            position: relative;
            top: 0.18em;
        }

        table th {
            text-align: left;
        }

        .files:nth-child(2n) {
            background-color: var(--tr-dark-shade-clr);
        }

        tfoot {
            font-size: 0.8em;   
        }

        form {
            margin: 0;
        }

        #open-explorer svg {
            max-width: 1.25em;
            max-height: 1.25em;
        }

        blockquote.container {
            font-family: Garamond, serif;
            margin-top: 3em;
            display: table;
        }

        .author {

        }

        .quote::before, .quote::after {
            content: '"';
        }




    </style>

    



</head>
<body>

    <div class="container window text-center secondary-text-clr">

        <header>
            <h1>Projects index page</h1>

            <br>

            <p>
                <code>
                    <?php echo __DIR__; ?>
                </code>
            </p>

        </header>
    
        <main>

            <table class="container primary-text-clr" width="100%">

                <thead>

                    <tr>
                        <!-- GET requests using href -->
                        <!-- <th></th> -->
                        <th abbr="File names" title="Sort alphabetically"><a href="?">Name</a></th>
                        <th abbr="Last file edit" title="Sort by time of edit"><a href="?">Last Modified</a></th>
                        <th class="text-right" abbr="Size of file" title="Sort by file size"><a href="?">Size</a></th>
                    </tr>

                    <tr>
                        <th colspan="5"><hr></th>
                    </tr>

                </thead>

                <tbody>

                    <?php foreach($files as $file): ?>
                        <tr class="files">
                            <td class="icons text-left"><a href="<?php echo $file->name; ?>"><?php echo $file->icon . ' ' . $file->name; ?></a></td>
                            <td class="text-left"><?php echo $file->date_edited; ?></td>

                            <?php $formatted_bytes = File::format_bytes($file->size); $folder_size += $file->size ?>

                            <td class="text-right"><?php echo $formatted_bytes['value']; ?></td>
                            <td class="text-right"><?php echo $formatted_bytes['prefix']; ?></td>
                        </tr>
                    <?php endforeach; ?>

                </tbody>

                <tfoot>

                    <tr>
                        <th colspan="5"><hr></th>
                    </tr>

                    <tr>
                        <td class="text-left" colspan="2">
                            <?php echo apache_get_version(); ?>
                            <a hidden href="#">View more</a>
                        </td>
                        <td class="text-right"><?php echo implode(' ', File::format_bytes($folder_size)); ?></td>
                        <td class="text-right" title="Open folder in explorer">
                            <form name="open-explorer-form" action="<?php echo $_SERVER['PHP_SELF'] ?>" method="post">
                                
                                <input type="hidden" name="open_root" value="true">
                                <a id="open-explorer" href="#">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="48" width="48" viewbox="0 0 48 48"><path d="M7 40q-1.15 0-2.075-.925Q4 38.15 4 37V11q0-1.15.925-2.075Q5.85 8 7 8h12.8q.6 0 1.175.25.575.25.975.65l2.1 2.1H41q1.15 0 2.075.925Q44 12.85 44 14H22.75l-3-3H7v26l4.5-17.75q.25-1 1.1-1.625.85-.625 1.85-.625H43.1q1.45 0 2.4 1.15t.55 2.6l-4.4 16.95q-.3 1.2-1.1 1.75T38.5 40Zm3.15-3h28.6l4.2-17h-28.6Zm0 0 4.2-17-4.2 17ZM7 17v-6 6Z"/></svg>
                                </a>
                        
                            </form>
                        </td>
                       
                    </tr>
                </tfoot>
            </table>
        </main>
    
        <footer>

            <blockquote class="container">

                    <p class="quote"><?php echo $random_quote; ?></p>
                    <p class="author text-right"><strong><?php echo QUOTES[$random_quote]; ?></strong></p>

            </blockquote>

        </footer>

    </div>

    <script>
        // open in explorer post request
        // document.getElementById('open-explorer').addEventListener('click', function(event) {
            
        //     event.preventDefault()

        //     fetch(window.location.href, {
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json',
        //         },
        //         body: JSON.stringify({ open_root: true })
        //     })
        //     .then(data => {
        //         console.log('Fetch successful:', data)
        //     })
        //     .catch((error) => {
        //         console.error('Error:', error)
        //     })

        // });

        // open in explorer post request
        document.getElementById('open-explorer').addEventListener('click', function(event) {
            
            event.preventDefault()

            document.forms['open-explorer-form'].submit()
        })
        

    </script>

</body>




</html>